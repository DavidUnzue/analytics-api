# Analytics Service API

## Setup and configuration

### Installation

You will need Node.js (tested with v14.4.0) and MondoDB (tested with v4.2.8) installed and running. MongoDB port should be configured in the environmnet variables as described below.

Install dependencies:

```bash
$ npm install
```

### Environment variables

The project uses [dotenv](https://www.npmjs.com/package/dotenv) to load environment variables stored in the `.env` file. Following information is defined here:

- Host and port to run the app
- Host and port where the MongoDB database is running
- Name of the MongoDB database to be used by the app
- API Token to secure HTTP requests from clients

## Start the application

Start dev server:

```bash
# development
$ npm run start

# watch mode
$ npm run start:dev
```

The API server will run under `http://localhost:7000`.

## Page Views

Every page view is an entity with multiple properties like page ID, user ID (IP address), browser name, time viewed, etc. This gets stored as a Document in the DB.

## API Endpoints

Every request must send a custom Header called `Api-Token` with the corresponding token (see `.env` file) for authorization.

**`/page-views`**  
Page views can be found under the route: `/page-views`.
The endpoint accepts query params for filtering/queries (`where`) and for projections (`projection`). In general you will find that most MongoDB queries work.

The endpoint returns a list of page view entities.

**`/page-views/rate`**  
There is a special route for retrieving the rate of returning users under `/page-views/rate`. The endpoint accepts query params for filtering/queries (`where`).

The endpoint returns an object like:

```
{ rate: 60 }
```

### Generate new page views

`POST http://localhost:7000/page-views`

You can generate new page views either by using the angular client as described in the client's repository README.

Or you can generate new mock views programmatically using the API from a client like `curl` or `Postman`:

```bash
curl --location --request POST 'http://localhost:7000/page-views' \
--header 'Api-Token: 123456789' \
--header 'Content-Type: application/json' \
--data-raw '{
    "pageId": "page-1"
}'
```

As you see, it is only necessary to send the ID of the page you want to generate a new view for. All other attributes like country, browser name, user ID, etc will be generated by the backend.

However, you can force them manually:

```bash
curl --location --request POST 'http://localhost:7000/page-views' \
--header 'Api-Token: 123456789' \
--header 'Content-Type: application/json' \
--data-raw '{
    "pageId": "page-1",
    "country": "Germany",
    "browserName": "Firefox",
    "userId": "69.89.31.226"
}'
```

**Note**: if not manually given, the userId defaults to the IP address the request came from.

### Get all page views

`GET http://localhost:7000/page-views`

```bash
curl --location --request GET 'http://localhost:7000/page-views' \
--header 'Api-Token: 123456789'
```

### Get page views by page id

`GET http://localhost:7000/page-views?where={"pageId": "page-1"}`

```bash
curl --location --request GET 'http://localhost:7000/page-views?where={%22pageId%22:%20%22page-1%22}' \
--header 'Api-Token: 123456789'
```

### Get page views by country

`GET http://localhost:7000/page-views?where={"country": "Germany"}`

```bash
curl --location --request GET 'http://localhost:7000/page-views?where={%22country%22:%20%22Germany%22}' \
--header 'Api-Token: 123456789'
```

### Get page views by countries

`GET http://localhost:7000/page-views?where={ "$or": [ { "country": "Germany" }, { "country": "France" } ] }`

```bash
curl --location --request GET 'http://localhost:7000/page-views?where={%20%22$or%22:%20[%20{%20%22country%22:%20%22Germany%22%20},%20{%20%22country%22:%20%22France%22%20}%20]%20}' \
--header 'Api-Token: 123456789'
```

### Get page activity for a given period of time

`GET http://localhost:7000/page-views?where={"pageId": "page1", "viewedAt" : {"$gte": 1593335945884}}`

```bash
curl --location --request GET 'http://localhost:7000/page-views?where={%22pageId%22:%20%22page1%22,%20%20%22viewedAt%22%20:%20{%22$gte%22:%201593335945884}}' \
--header 'Api-Token: 123456789'
```

### Get the rate of returning users for a given period of time for a page

This uses the endpoint `/page-views/rate`.

`GET http://localhost:7000/page-views/rate?where={"pageId": "page1", "viewedAt" : {"$gte": 1593335945884}}`

```bash
curl --location --request GET 'http://localhost:7000/page-views/rate?where={%22pageId%22:%20%22page1%22,%20%20%22viewedAt%22%20:%20{%22$gte%22:%201593335945884}}' \
--header 'Api-Token: 123456789'
```

## Author

David Unzu√©  
[davidunzue.com](davidunzue.com)
